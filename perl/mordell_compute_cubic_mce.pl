#!perl

# https://hhr-m.de/mordell/
# https://hhr-m.de/mordell/big_table.txt
#   (X**3 + K) = Y**2

use 5.014; # //, strict, say, s///r
use warnings;
use Math::BigInt;
use Time::HiRes qw/time/;
use MCE::Loop;  # replace threads and Thread::Queue with MCE::Loop

my $T0 = time;

sub is_perfect_square
{
    my $rtsq = $_[0]->copy()->bsqrt->bpow(2);   # floor(sqrt(arg))**2
    $rtsq == $_[0];
}

sub compute_cubic_mordell
{
    my $t0 = time;
    my $q = Math::BigInt->new(''.$_[0]);
    my $id = $_[1] // -1;
    my $k = $q ** 3;
    my $x = -($q->copy);
    #printf "for k=%s, start at x=%s and work your way up\n", $k, $x;
    my @answers=();
    while ($x <= 10000) {
        my $m = $x**3 + $k;
        if(is_perfect_square($m)) {
            my $y = $m->copy->bsqrt;
            #printf "%s**3 + %s = %s = %s**2\n", $x, $k, $m, $y;
            push @answers, [$x,$y];
        }
        ++$x;
    }
    my $dt = time - $t0;
    my $DT = time - $T0;
    if(1 && @answers) {
        printf "[%03d][%12.6fs][%12.6fs] q=%s k=%s", $id, $DT, $dt, $q, $k;
        printf "(%s,%s)", $_->[0], $_->[1] for @answers;
        print "\n";
    }
    #printf STDERR "[%d][%12.6fs][%12.6fs] compute_cubic_mordell(%s)\n", $id, $DT, $dt, $q;
}

if(0) {
    # sequential version
    for(1..30) {
        my $arg = Math::BigInt->new($_);
        #printf "%d %s perfect square\n", $arg, is_perfect_square($arg) ? 'is' : 'is not';
        compute_cubic_mordell($arg);
        compute_cubic_mordell(-$arg);
    }
} elsif(0) {
    # threaded version
    my $Q = Thread::Queue->new();
    my $nWorkers = 10;
    #$Q->limit(10);  # should only allow 10 active items in the queue at once...

    sub worker_task {
        while( defined (my $arg = $Q->dequeue)) {
            compute_cubic_mordell($arg, threads->tid());
        }
    }

    # make five workers
    my @workers = map { threads->create(\&worker_task) } 1..$nWorkers;

    # enqueue everything
    for(1..100) {
        $Q->enqueue($_);
        $Q->enqueue(-$_);
    }

    # done
    $Q->end();
    $_->join() for @workers;

} else {
    # MCE version
    my $nWorkers = 10;
    MCE::Loop->init(
        max_workers => $nWorkers,
        chunk_size => 1,    # only pass one at a time
    );

    #sub worker_task {
    #    while( defined (my $arg = $Q->dequeue)) {
    #        compute_cubic_mordell($arg, threads->tid());
    #    }
    #}

    ## make five workers
    #my @workers = map { threads->create(\&worker_task) } 1..$nWorkers;

    # enqueue everything
    mce_loop {
        my ($mce, $chunk_ref, $chunk_id) = @_;
        compute_cubic_mordell(+$_, $chunk_id);
        compute_cubic_mordell(-$_, $chunk_id);
    } 1 .. 100;

}

__END__
[001][    1.296384s][    1.253399s] q=3 k=27(-3,0)
[009][    1.395611s][    1.351886s] q=8 k=512(-8,0)(-7,13)(4,24)(8,32)(184,2496)
[007][    1.423909s][    1.379036s] q=9 k=729(-9,0)(0,27)(18,81)
[002][    1.446249s][    1.401107s] q=10 k=1000(-10,0)(-6,28)(65,525)
[003][    1.446249s][    1.403425s] q=1 k=1(-1,0)(0,1)(2,3)
[004][    1.458736s][    1.415895s] q=2 k=8(-2,0)(1,3)(2,4)(46,312)
[010][    1.474764s][    1.431145s] q=7 k=343(-7,0)(21,98)
[008][    1.541879s][    1.498638s] q=4 k=64(-4,0)(0,8)(8,24)
[005][    1.556868s][    1.513580s] q=5 k=125(-5,0)
[006][    1.620966s][    1.577404s] q=6 k=216(-6,0)
[007][    2.770236s][    1.346060s] q=13 k=2197(-13,0)
[001][    2.829582s][    1.532942s] q=11 k=1331(-11,0)(37,228)
[010][    2.892114s][    1.416826s] q=17 k=4913(-17,0)
[009][    2.892113s][    1.496258s] q=12 k=1728(-12,0)
[003][    2.902480s][    1.456039s] q=15 k=3375(-15,0)
[004][    2.916518s][    1.457551s] q=16 k=4096(-16,0)(0,64)(32,192)
[002][    2.978925s][    1.532362s] q=14 k=2744(-14,0)(-7,49)(70,588)
[005][    3.041558s][    1.484493s] q=19 k=6859(-19,0)
[008][    3.134084s][    1.591971s] q=18 k=5832(-18,0)(9,81)(18,108)(414,8424)
[006][    3.146487s][    1.525297s] q=20 k=8000(-20,0)
[007][    4.119607s][    1.349074s] q=21 k=9261(-21,0)(7,98)
[001][    4.252101s][    1.422290s] q=22 k=10648(-22,0)(26,168)
[009][    4.318118s][    1.425607s] q=24 k=13824(-24,0)
[004][    4.367677s][    1.450874s] q=26 k=17576(-26,0)(22,168)
[003][    4.386184s][    1.483579s] q=25 k=15625(-25,0)(0,125)(50,375)
[010][    4.406573s][    1.514245s] q=23 k=12167(-23,0)(1177,40380)
[002][    4.643093s][    1.663915s] q=27 k=19683(-27,0)
[008][    4.698636s][    1.564292s] q=29 k=24389(-29,0)
[005][    4.706157s][    1.664354s] q=28 k=21952(-28,0)(-7,147)(84,784)
[006][    4.811506s][    1.664797s] q=30 k=27000(-30,0)
[007][    5.526040s][    1.406044s] q=31 k=29791(-31,0)
[001][    5.706649s][    1.454321s] q=32 k=32768(-32,0)(-28,104)(16,192)(32,256)(736,19968)
[003][    5.737306s][    1.350892s] q=35 k=42875(-35,0)(665,17150)
[010][    5.819503s][    1.412688s] q=36 k=46656(-36,0)(0,216)(72,648)
[009][    5.860187s][    1.541802s] q=33 k=35937(-33,0)(-6,189)(88,847)
[004][    5.878173s][    1.510248s] q=34 k=39304(-34,0)(450,9548)
[002][    6.248458s][    1.605176s] q=37 k=50653(-37,0)(11,228)(407,8214)
[008][    6.283088s][    1.584278s] q=38 k=54872(-38,0)(1178,40432)
[006][    6.299148s][    1.487451s] q=40 k=64000(-40,0)(-24,224)(260,4200)
[005][    6.391361s][    1.685057s] q=39 k=59319(-39,0)
[007][    7.085709s][    1.559486s] q=41 k=68921(-41,0)
[001][    7.134024s][    1.427114s] q=42 k=74088(-42,0)
[009][    7.255923s][    1.395490s] q=45 k=91125(-45,0)
[010][    7.296288s][    1.476584s] q=44 k=85184(-44,0)(148,1824)
[003][    7.320646s][    1.581702s] q=43 k=79507(-43,0)
[004][    7.394870s][    1.516499s] q=46 k=97336(-46,0)(2,312)
[008][    7.704608s][    1.421331s] q=48 k=110592(-48,0)
[002][    7.768079s][    1.519341s] q=47 k=103823(-47,0)
[005][    7.819842s][    1.428284s] q=50 k=125000(-50,0)(25,375)(50,500)(1150,39000)
[006][    7.819842s][    1.520444s] q=49 k=117649(-49,0)(0,343)(98,1029)
[007][    8.474855s][    1.388942s] q=51 k=132651(-51,0)
[001][    8.572693s][    1.438399s] q=52 k=140608(-52,0)
[009][    8.667260s][    1.411079s] q=53 k=148877(-53,0)
[003][    8.745795s][    1.424783s] q=55 k=166375(-55,0)
[004][    8.764272s][    1.369219s] q=56 k=175616(-56,0)(-28,392)(65,671)(280,4704)
[010][    8.774294s][    1.477760s] q=54 k=157464(-54,0)
[006][    9.234841s][    1.414771s] q=60 k=216000(-60,0)
[008][    9.345057s][    1.640253s] q=57 k=185193(-57,0)(-38,361)(112,1261)(456,9747)
[002][    9.385071s][    1.616795s] q=58 k=195112(-58,0)
[005][    9.463279s][    1.643097s] q=59 k=205379(-59,0)
[007][    9.957635s][    1.482514s] q=61 k=226981(-61,0)
[009][   10.168799s][    1.501309s] q=63 k=250047(-63,0)(189,2646)
[004][   10.169804s][    1.405357s] q=65 k=274625(-65,0)(-26,507)(10,525)(56,671)(91,1014)(104,1183)(260,4225)(610,15075)
[001][   10.190216s][    1.617308s] q=62 k=238328(-62,0)
[010][   10.220384s][    1.445923s] q=66 k=287496(-66,0)
[003][   10.294498s][    1.548321s] q=64 k=262144(-64,0)(0,512)(128,1536)
[006][   10.758064s][    1.523050s] q=67 k=300763(-67,0)
[002][   10.895276s][    1.510034s] q=69 k=328509(-69,0)
[008][   10.949440s][    1.604122s] q=68 k=314432(-68,0)
[005][   10.991465s][    1.527795s] q=70 k=343000(-70,0)(14,588)(105,1225)
[007][   11.401302s][    1.443401s] q=71 k=357911(-71,0)(-23,588)
[009][   11.532735s][    1.363686s] q=72 k=373248(-72,0)(-63,351)(36,648)(72,864)(1656,67392)
[001][   11.583534s][    1.393153s] q=74 k=405224(-74,0)(-47,549)
[004][   11.609584s][    1.439566s] q=73 k=389017(-73,0)
[010][   11.675576s][    1.454967s] q=75 k=421875(-75,0)
[003][   11.752985s][    1.458236s] q=76 k=438976(-76,0)
[006][   12.270263s][    1.510857s] q=77 k=456533(-77,0)
[008][   12.376566s][    1.426903s] q=79 k=493039(-79,0)
[002][   12.418732s][    1.523210s] q=78 k=474552(-78,0)(-26,676)(273,4563)(354,6696)
[005][   12.619935s][    1.628217s] q=80 k=512000(-80,0)
[007][   12.808778s][    1.407257s] q=81 k=531441(-81,0)(0,729)(162,2187)
[004][   12.992745s][    1.382885s] q=84 k=592704(-84,0)(28,784)(105,1323)
[009][   13.050175s][    1.517227s] q=82 k=551368(-82,0)
[001][   13.123762s][    1.540057s] q=83 k=571787(-83,0)
[010][   13.126019s][    1.450245s] q=85 k=614125(-85,0)
[003][   13.254203s][    1.501043s] q=86 k=636056(-86,0)(602,14792)
[006][   13.829672s][    1.559201s] q=87 k=658503(-87,0)
[008][   13.883636s][    1.506827s] q=88 k=681472(-88,0)(33,847)(104,1344)
[002][   13.883636s][    1.464696s] q=89 k=704969(-89,0)
[005][   14.125474s][    1.505302s] q=90 k=729000(-90,0)(-54,756)(585,14175)
[007][   14.288862s][    1.479618s] q=91 k=753571(-91,0)(65,1014)
[004][   14.408090s][    1.415082s] q=92 k=778688(-92,0)(4708,323040)
[001][   14.408090s][    1.284005s] q=94 k=830584(-94,0)
[009][   14.541968s][    1.491569s] q=93 k=804357(-93,0)
[010][   14.608306s][    1.482004s] q=95 k=857375(-95,0)(1121,37544)
[003][   14.715285s][    1.460680s] q=96 k=884736(-96,0)
[002][   15.141481s][    1.257206s] q=99 k=970299(-99,0)(333,6156)
[008][   15.176509s][    1.292435s] q=98 k=941192(-98,0)(49,1029)(98,1372)(2254,107016)
[006][   15.192791s][    1.362904s] q=97 k=912673(-97,0)
[005][   15.354550s][    1.228865s] q=100 k=1000000(-100,0)(0,1000)(200,3000)



1(-1,0)(0,1)(2,3)
8(-2,0)(1,3)(2,4)(46,312)
27(-3,0)
64(-4,0)(0,8)(8,24)
125(-5,0)
216(-6,0)
343(-7,0)(21,98)
512(-8,0)(-7,13)(4,24)(8,32)(184,2496)
729(-9,0)(0,27)(18,81)
1000(-10,0)(-6,28)(65,525)
1331(-11,0)(37,228)
1728(-12,0)
2197(-13,0)
2744(-14,0)(-7,49)(70,588)
3375(-15,0)
4096(-16,0)(0,64)(32,192)
4913(-17,0)
5832(-18,0)(9,81)(18,108)(414,8424)
6859(-19,0)
8000(-20,0)
9261(-21,0)(7,98)
10648(-22,0)(26,168)
12167(-23,0)(1177,40380)
13824(-24,0)
15625(-25,0)(0,125)(50,375)
17576(-26,0)(22,168)
19683(-27,0)
21952(-28,0)(-7,147)(84,784)
24389(-29,0)
27000(-30,0)
29791(-31,0)
32768(-32,0)(-28,104)(16,192)(32,256)(736,19968)
35937(-33,0)(-6,189)(88,847)
39304(-34,0)(450,9548)
42875(-35,0)(665,17150)
46656(-36,0)(0,216)(72,648)
50653(-37,0)(11,228)(407,8214)
54872(-38,0)(1178,40432)
59319(-39,0)
64000(-40,0)(-24,224)(260,4200)
68921(-41,0)
74088(-42,0)
79507(-43,0)
85184(-44,0)(148,1824)
91125(-45,0)
97336(-46,0)(2,312)
103823(-47,0)
110592(-48,0)
117649(-49,0)(0,343)(98,1029)
125000(-50,0)(25,375)(50,500)(1150,39000)
132651(-51,0)
140608(-52,0)
148877(-53,0)
157464(-54,0)
166375(-55,0)
175616(-56,0)(-28,392)(65,671)(280,4704)
185193(-57,0)(-38,361)(112,1261)(456,9747)
195112(-58,0)
205379(-59,0)
216000(-60,0)
226981(-61,0)
238328(-62,0)
250047(-63,0)(189,2646)
262144(-64,0)(0,512)(128,1536)
274625(-65,0)(-26,507)(10,525)(56,671)(91,1014)(104,1183)(260,4225)(610,15075)
287496(-66,0)
300763(-67,0)
314432(-68,0)
328509(-69,0)
343000(-70,0)(14,588)(105,1225)
357911(-71,0)(-23,588)
373248(-72,0)(-63,351)(36,648)(72,864)(1656,67392)
389017(-73,0)
405224(-74,0)(-47,549)
421875(-75,0)
438976(-76,0)
456533(-77,0)
474552(-78,0)(-26,676)(273,4563)(354,6696)
493039(-79,0)
512000(-80,0)
531441(-81,0)(0,729)(162,2187)
551368(-82,0)
571787(-83,0)
592704(-84,0)(28,784)(105,1323)
614125(-85,0)
636056(-86,0)(602,14792)
658503(-87,0)
681472(-88,0)(33,847)(104,1344)
704969(-89,0)
729000(-90,0)(-54,756)(585,14175)
753571(-91,0)(65,1014)
778688(-92,0)(4708,323040)
804357(-93,0)
830584(-94,0)
857375(-95,0)(1121,37544)
884736(-96,0)
912673(-97,0)
941192(-98,0)(49,1029)(98,1372)(2254,107016)
970299(-99,0)(333,6156)
1000000(-100,0)(0,1000)(200,3000)
